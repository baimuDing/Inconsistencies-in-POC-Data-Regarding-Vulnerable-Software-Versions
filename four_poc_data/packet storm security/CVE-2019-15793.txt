{
    "text": "title : Ubuntu shiftfs refcount Underflow / Type Confusion  ， detail : Ubuntu suffers from refcount underflow and type confusion vulnerabilities in shiftfs.  ， cve : advisories | CVE-2019-15793  ，  ， desc : Ubuntu : refcount underflow and type confusion in shiftfs  ， Tested on Ubuntu 19.10 , kernel \\\"5.3.0-19-generic # 20-Ubuntu\\\".  ， Ubuntu ships a filesystem \\\"shiftfs\\\" in fs/shiftfs.c in the kernel tree that  ， doesn't exist upstream. This filesystem can be mounted from user namespaces ,   ， meaning that this is attack surface from unprivileged userspace in the default  ， installation.  ， There are two memory safety bugs around shiftfs_btrfs_ioctl_fd_replace (  ) .  ，  # Bug 1 : Flawed reference counting #   ， In shiftfs_btrfs_ioctl_fd_replace (  )  ( \\\"/\\\" comments added by me )  :   ， \\tsrc = fdget ( oldfd )  ;   ， \\tif (  ! src.file )   ， \\t\\treturn -EINVAL ;   ， \\t/ src holds one reference ( assuming multithreaded execution )   ， \\tret = shiftfs_real_fdget ( src.file , lfd )  ;   ， \\t/ lfd->file is a file * now , but shiftfs_real_fdget didn't take any  ， \\t/ extra references  ， \\tfdput ( src )  ;   ， \\t/ this drops the only reference we were holding on src , and src was  ， \\t/ the only thing holding a reference to lfd->file. lfd->file may be  ， \\t/ dangling at this point.  ， \\tif ( ret )   ， \\t\\treturn ret ;   ， \\t * newfd = get_unused_fd_flags ( lfd->file->f_flags )  ;   ， \\tif (  * newfd < 0 ) {  ， \\t\\t/ always a no-op  ， \\t\\tfdput (  * lfd )  ;   ， \\t\\treturn * newfd ;   ， \\t}  ， \\tfd_install (  * newfd , lfd->file )  ;   ， \\t/ fd_install (  ) consumes a counted reference , but we don't hold any  ， \\t/ counted references. so at this point , if lfd->file hasn't been freed  ， \\t/ yet , its refcount is one lower than it ought to be.  ， \\t [ . ]   ， \\t/ the following code is refcount-neutral , so the refcount stays one too  ， \\t/ low.  ， \\tif ( ret )   ， \\t\\tshiftfs_btrfs_ioctl_fd_restore ( cmd ,  * lfd ,  * newfd , arg , v1 , v2 )  ;   ， shiftfs_real_fdget (  ) is implemented as follows : ",
    "time": "Nov 14, 2019"
}