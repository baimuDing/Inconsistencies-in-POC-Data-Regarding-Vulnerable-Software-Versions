{
    "text": "vul_name : Windows sxssrv ! BaseSrvActivationContextCacheDuplicateUnicodeString Heap Buffer Overflow ， vul_cve : CVE-2022-22049 ， vul_poc : Windows : heap buffer overflow in sxssrv ! BaseSrvActivationContextCacheDuplicateUnicodeString ， SUMMARY ， A heap buffer overflow issue exists in Windows 11 and earlier versions. A malicious application may be able to execute arbitrary code with SYSTEM privileges. ， VULNERABILITY DETAILS ， ` ， _int64 _fastcall BaseSrvActivationContextCacheDuplicateUnicodeString ( UNICODE_STRING * Dst , UNICODE_STRING * Src )  ， { ， unsigned int Length ; / ebx ， SIZE_T NewMaxLength ; / r8 ， WCHAR * Heap ; / rax ， _int64 Status ; / rax ， Length = Src->Length ;  ， { ， NewMaxLength = ( unsigned _int16 )  ( Length + 2 )  ; / 1 ， Dst->MaximumLength = NewMaxLength ;  ， Heap = ( WCHAR *  ) RtlAllocateHeap ( NtCurrentPeb (  ) ->ProcessHeap , 0 , NewMaxLength )  ; / 2 ， Dst->Buffer = Heap ;  ， { ， memcpy_0 ( Heap , Src->Buffer , Length )  ; / 3 ， Dst->Buffer [  ( unsigned _int64 ) Length 1 ] = 0 ;  ， Status = 0i64 ;  ， Dst->Length = Length ;  ， } ， { ， } ， } ， { ，  *  ( _DWORD *  ) &Dst->Length = 0 ;  ， Status = 0i64 ;  ， Dst->Buffer = 0i64 ;  ， } ， } ， ` ， The function above attempts to reserve two extra bytes for a trailing null character. The new size gets truncated to a 16-bit value [ 1 ]  , so if the size of the source string is 0xfffe bytes , the function will try to allocate a 0-byte buffer [ 2 ] and copy 0xfffe bytes into it [ 3 ] . ， The vulnerable function is reachable from the `BaseSrvSxsCreateActivationContextFromMessage` CSR routine. However , the default size of the CSR shared memory section is only 0x10000 bytes , and some of that space must be reserved for the capture buffer header , so by default it's impossible to pass a big enough `UNICODE_STRING` to CSRSS. Luckily , the size of the section is controlled entirely by the client process , and if an attacker can modify `ntdll ! CsrpConnectToServer` early enough during process startup , they'll be able to pass strings of ( virtually ) any size. ， VERSION ， Windows 11 12H2 ( OS Build 22000.593 )  ， Windows 10 12H2 ( OS Build 19044.1586 )  ， REPRODUCTION CASE ， This ( not very reliable ) proof-of-concept creates a new process in a suspended state , attempts to find and replace 32-bit value 0x10000 inside `CsrpConnectToServer` , and resumes the process' main thread. Then the child process sends a CSR request with a huge string. ， 1 ) Enable page heap verification for csrss.exe :  ， ` ， gflags /p /enable csrss.exe /full ， ` ， 2 ) Restart the machine. ， 3 ) Compile and run :  ， `",
    "time": "2022.08.14"
}